name: Build Release Executable

on:
  release:
    types: [created]

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Build executable
        run: |
          Write-Host "Starting PyInstaller build..."
          Write-Host "Python version:"
          python --version
          Write-Host "PyInstaller version:"
          pyinstaller --version
          
          # Build with CustomTkinter support
          pyinstaller `
            --onefile `
            --windowed `
            --add-data "folder_defs.json;." `
            --hidden-import customtkinter `
            --hidden-import tkinter `
            --hidden-import PIL `
            --hidden-import PIL._tkinter_finder `
            --name "SpaceCleanserPro" `
            --noconfirm `
            main.py
          
          Write-Host "PyInstaller build completed"
          
          if (-not (Test-Path "dist\SpaceCleanserPro.exe")) {
            Write-Error "Build failed - executable not found in dist folder"
            Write-Host "Contents of dist folder:"
            Get-ChildItem -Path "dist" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host $_.FullName }
            Write-Host "Contents of build folder:"
            Get-ChildItem -Path "build" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host $_.FullName }
            exit 1
          }
          
          Write-Host "Build successful! Executable size:"
          $sizeMB = (Get-Item "dist\SpaceCleanserPro.exe").Length / 1MB
          Write-Host "$sizeMB MB"
      
      - name: Extract version from tag
        id: get_version
        run: |
          $tag = "${{ github.ref }}"
          # Remove "refs/tags/" prefix, then remove optional "v" prefix
          $version = $tag -replace "refs/tags/", "" -replace "^v", ""
          Write-Host "Extracted version: $version"
          echo "version=$version" >> $env:GITHUB_OUTPUT
      
      - name: Rename executable with version
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          Write-Host "Renaming with version: $version"
          if (-not (Test-Path "dist\SpaceCleanserPro.exe")) {
            Write-Error "Source file not found: dist\SpaceCleanserPro.exe"
            exit 1
          }
          Move-Item -Path "dist\SpaceCleanserPro.exe" -Destination "dist\SpaceCleanserPro-v$version.exe"
          Write-Host "Renamed to: dist\SpaceCleanserPro-v$version.exe"
      
      - name: Upload release asset
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          $filePath = "dist\SpaceCleanserPro-v$version.exe"
          $fileName = "SpaceCleanserPro-v$version.exe"
          
          if (-not (Test-Path $filePath)) {
            Write-Error "File not found: $filePath"
            exit 1
          }
          
          $uploadUrl = "${{ github.event.release.upload_url }}".Replace("{?name,label}", "?name=$fileName")
          Write-Host "Uploading $fileName to release..."
          $headers = @{
            "Authorization" = "Bearer ${{ secrets.GITHUB_TOKEN }}"
            "Content-Type" = "application/octet-stream"
          }
          try {
            Invoke-RestMethod -Method Post -Uri $uploadUrl -Headers $headers -InFile $filePath
            Write-Host "Upload successful!"
          } catch {
            Write-Error "Upload failed: $_"
            exit 1
          }
